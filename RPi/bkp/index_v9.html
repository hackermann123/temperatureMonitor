<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temperature Monitoring System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4CAF50;
        }

        .status-indicator.offline {
            background: #f44336;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
            padding-bottom: 0;
        }

        .tab-btn {
            padding: 12px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab-btn:hover {
            color: #667eea;
            background: #f9f9f9;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .card h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
        }

        .sensors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .sensor-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .sensor-card .name {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .sensor-card .temperature {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .sensor-card .status {
            font-size: 12px;
            opacity: 0.7;
        }

        .sensor-card.offline {
            background: linear-gradient(135deg, #999 0%, #666 100%);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .status-message {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }

        .status-message.success {
            background: #c8e6c9;
            color: #2e7d32;
            display: block;
        }

        .status-message.error {
            background: #ffcdd2;
            color: #c62828;
            display: block;
        }

        .status-message.info {
            background: #bbdefb;
            color: #1565c0;
            display: block;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .logging-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .logging-control-group {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
        }

        .probe-rename-form {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
        }

        /* SERIAL MONITOR STYLES */
        .serial-monitor {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 450px;
            overflow-y: auto;
            border: 1px solid #333;
            line-height: 1.5;
        }

        .monitor-line {
            margin: 2px 0;
            padding: 3px 5px;
            word-break: break-word;
        }

        .monitor-line.temperature {
            color: #4ec9b0;
        }

        .monitor-line.info {
            color: #569cd6;
        }

        .monitor-line.warning {
            color: #ce9178;
        }

        .monitor-line.error {
            color: #f48771;
        }

        .monitor-line.unknown {
            color: #858585;
        }

        .monitor-line.raw {
            color: #d4d4d4;
        }

        .monitor-timestamp {
            color: #666;
            font-size: 10px;
            margin-right: 8px;
        }

        .monitor-type {
            color: #999;
            font-size: 10px;
            margin-right: 8px;
        }

        .serial-filter-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .serial-filter-wrapper select {
            padding: 10px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 14px;
        }

        .serial-legend {
            margin-top: 15px;
            font-size: 12px;
            color: #666;
        }

        .serial-legend span {
            margin-right: 20px;
            display: inline-block;
        }

        @media (max-width: 768px) {
            .sensors-grid {
                grid-template-columns: 1fr;
            }

            .logging-controls {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .button-group button,
            .button-group select {
                width: 100%;
            }

            .tabs {
                flex-direction: row;
            }

            .probe-rename-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üå°Ô∏è Temperature Monitoring System</h1>
            <p>Real-time sensor data monitoring and logging</p>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-indicator" id="serialStatus"></div>
                    <span id="serialStatusText">Connecting...</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator" id="systemStatus"></div>
                    <span id="systemStatusText">System Status</span>
                </div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('sensors')">üìä Sensors</button>
            <button class="tab-btn" onclick="switchTab('logging')">üìù Data Logging</button>
            <button class="tab-btn" onclick="switchTab('graphs')">üìà Historical Graphs</button>
            <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
            <button class="tab-btn" onclick="switchTab('serialmonitor')">üñ•Ô∏è Serial Monitor</button>
        </div>

        <!-- SENSORS TAB -->
        <div id="sensors" class="tab-content active">
            <div class="card">
                <h2>Current Sensor Readings</h2>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="rescanSensors()">üîÑ Rescan Sensors</button>
                    <button class="btn btn-secondary" onclick="refreshSensors()">üîÉ Refresh Now</button>
                    <button class="btn btn-primary" id="mockModeBtn" onclick="toggleMockMode()" style="display: none;">‚úì Disable Mock Mode</button>
                    <button class="btn btn-primary" id="enableMockBtn" onclick="enableMockMode()">‚úì Enable Mock Mode</button>
                </div>
                <div id="statusMessage" class="status-message"></div>
                <div class="sensors-grid" id="sensorsGrid">
                    <div class="sensor-card">
                        <div class="name">Loading...</div>
                        <div class="temperature">--¬∞C</div>
                        <div class="status">Waiting for data</div>
                    </div>
                </div>

                <div id="renameSection" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #f0f0f0;">
                    <h3>Rename Probes</h3>
                    <div id="renameForm"></div>
                </div>
            </div>
        </div>

        <!-- LOGGING TAB -->
        <div id="logging" class="tab-content">
            <div class="card">
                <h2>Data Logging Control</h2>
                <div class="button-group">
                    <button class="btn btn-primary" id="startLoggingBtn" onclick="startLogging()">‚ñ∂ Start Logging</button>
                    <button class="btn btn-danger" id="stopLoggingBtn" onclick="stopLogging()" disabled>‚èπ Stop Logging</button>
                </div>

                <div class="logging-controls">
                    <div class="logging-control-group">
                        <div class="form-group">
                            <label>Session Duration (minutes)</label>
                            <input type="number" id="logDuration" min="1" max="1440" value="60" placeholder="Leave empty for unlimited">
                        </div>
                    </div>
                    <div class="logging-control-group">
                        <div class="form-group">
                            <label>Logging Interval (seconds)</label>
                            <input type="number" id="logInterval" min="1" max="300" value="60" placeholder="Time between readings">
                        </div>
                    </div>
                    <div class="logging-control-group">
                        <div class="form-group">
                            <label>Logging Status</label>
                            <input type="text" id="loggingStatus" readonly value="Stopped">
                        </div>
                    </div>
                </div>

                <div id="statusMessageLogging" class="status-message"></div>
            </div>
        </div>

        <!-- GRAPHS TAB -->
        <div id="graphs" class="tab-content">
            <div class="card">
                <h2>Historical Temperature Data</h2>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="loadGraphData()">üìä Load Data</button>
                    <button class="btn btn-secondary" onclick="downloadGraphData()">üì• Download CSV</button>
                </div>

                <div id="statusMessageGraphs" class="status-message"></div>

                <div id="sessionSelector" style="display: none; margin-bottom: 20px;">
                    <label for="sessionSelect">Select Session:</label>
                    <select id="sessionSelect" onchange="displayGraph()" style="margin-top: 10px;">
                        <option value="">Loading...</option>
                    </select>
                </div>

                <div class="chart-container">
                    <canvas id="temperatureChart"></canvas>
                </div>

                <div id="graphStats" style="display: none;">
                    <h3>Overall Statistics</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #f0f0f0;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 4px;">
                            <div style="font-size: 12px; opacity: 0.9;">Min Temperature</div>
                            <div style="font-size: 20px; font-weight: bold; margin-top: 8px;" id="statMin">--¬∞C</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 4px;">
                            <div style="font-size: 12px; opacity: 0.9;">Max Temperature</div>
                            <div style="font-size: 20px; font-weight: bold; margin-top: 8px;" id="statMax">--¬∞C</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 4px;">
                            <div style="font-size: 12px; opacity: 0.9;">Average Temperature</div>
                            <div style="font-size: 20px; font-weight: bold; margin-top: 8px;" id="statAvg">--¬∞C</div>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px;">Per-Sensor Statistics</h3>
                    <div id="perSensorStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 15px;">
                        <!-- Per-sensor stats will be inserted here by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settings" class="tab-content">
            <div class="card">
                <h2>System Settings</h2>
                <div class="form-group">
                    <label>Auto-refresh Interval (seconds)</label>
                    <input type="number" id="refreshInterval" min="1" max="60" value="2">
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">üíæ Save Settings</button>
            </div>

            <div class="card">
                <h2>System Information</h2>
                <div id="systemInfo" style="background: #f9f9f9; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; line-height: 1.6;">
                    <div>System State: <span id="infoSystemState">--</span></div>
                    <div>Logging State: <span id="infoLoggingState">--</span></div>
                    <div>Serial Connected: <span id="infoSerialConnected">--</span></div>
                    <div>Last Update: <span id="infoLastUpdate">--</span></div>
                </div>
            </div>
        </div>

        <!-- SERIAL MONITOR TAB -->
        <div id="serialmonitor" class="tab-content">
            <div class="card">
                <h2>Serial Monitor</h2>
                <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                    View all incoming serial data from Arduino. Shows messages, warnings, errors, and temperature readings.
                </p>

                <div class="serial-filter-wrapper">
                    <button class="btn btn-secondary" id="pauseResumeBtn" onclick="toggleSerialMonitor()">
                        ‚è∏Ô∏è Pause
                    </button>

                    <select id="serialFilter" onchange="updateSerialMonitor()">
                        <option value="">All Messages</option>
                        <option value="temperature">Temperature Data</option>
                        <option value="info">Info Only</option>
                        <option value="warning">Warnings Only</option>
                        <option value="error">Errors Only</option>
                    </select>

                    <button class="btn btn-secondary" onclick="downloadSerialLog()">
                        üì• Download Log
                    </button>

                    <button class="btn btn-danger" onclick="clearSerialMonitor()">
                        üóëÔ∏è Clear
                    </button>
                </div>

                <div class="serial-monitor" id="serialMonitor">
                    <div class="monitor-line info">Waiting for serial data...</div>
                </div>

                <div class="serial-legend">
                    <strong>Legend:</strong>
                    <span style="color: #4ec9b0;">‚óè Temperature Data</span>
                    <span style="color: #569cd6;">‚óè Info Messages</span>
                    <span style="color: #ce9178;">‚óè Warnings</span>
                    <span style="color: #f48771;">‚óè Errors</span>
                </div>
            </div>
        </div>

    </div>

    <script>
        // =====================================================================
        // CONFIGURATION
        // =====================================================================

        const API_BASE = '/api';
        let refreshIntervalMs = 2000;
        let autoRefreshTimer = null;
        let graphChart = null;
        let serialMonitorPaused = false;
        let serialMonitorInterval = null;

        // =====================================================================
        // TAB SWITCHING
        // =====================================================================

        function switchTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Hide all buttons
            const btns = document.querySelectorAll('.tab-btn');
            btns.forEach(btn => btn.classList.remove('active'));

            // Show selected tab and button
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Start serial monitor when switching to that tab
            if (tabName === 'serialmonitor') {
                startSerialMonitor();
            } else if (serialMonitorInterval) {
                clearInterval(serialMonitorInterval);
                serialMonitorInterval = null;
            }

            // Load initial data for certain tabs
            if (tabName === 'sensors') {
                refreshSensors();
            } else if (tabName === 'logging') {
                updateLoggingStatus();
            } else if (tabName === 'graphs') {
                loadGraphData();
            } else if (tabName === 'settings') {
                updateSystemInfo();
            }
        }

        // =====================================================================
        // STATUS UPDATES
        // =====================================================================

        function showStatus(message, type = 'info', elementId = 'statusMessage') {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `status-message ${type}`;
            setTimeout(() => {
                el.className = 'status-message';
            }, 5000);
        }

        function updateSystemStatus() {
            fetch(`${API_BASE}/system/status`)
                .then(r => r.json())
                .then(data => {
                    const statusEl = document.getElementById('systemStatus');
                    const statusText = document.getElementById('systemStatusText');
                    statusEl.className = data.serial_connected ? 'status-indicator' : 'status-indicator offline';
                    statusText.textContent = data.serial_connected ? 'Arduino Connected' : 'Arduino Offline';
                })
                .catch(err => console.error('Status update error:', err));
        }

        // =====================================================================
        // SENSORS TAB
        // =====================================================================

        function refreshSensors() {
            fetch(`${API_BASE}/sensors`)
                .then(r => {
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    return r.json();
                })
                .then(data => {
                    const grid = document.getElementById('sensorsGrid');
                    const sensors = data.sensors;

                    if (!sensors || Object.keys(sensors).length === 0) {
                        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">No sensors detected. Try rescanning.</div>';
                        return;
                    }

                    grid.innerHTML = Object.entries(sensors).map(([id, sensor]) => `
                        <div class="sensor-card ${sensor.status === 'offline' ? 'offline' : ''}">
                            <div class="name">${sensor.name}</div>
                            <div class="temperature">${sensor.status === 'online' ? sensor.temperature.toFixed(2) : '--'}¬∞C</div>
                            <div class="status">${sensor.status === 'online' ? '‚úì Online' : '‚úó Offline'}</div>
                        </div>
                    `).join('');

                    // Build rename form
                    const renameForm = document.getElementById('renameForm');
                    renameForm.innerHTML = Object.entries(sensors).map(([id, sensor]) => `
                        <div class="probe-rename-form">
                            <input type="text" id="rename_${id}" value="${sensor.name}" placeholder="Probe name">
                            <button class="btn btn-primary" onclick="renameSensor('${id}')">Rename</button>
                        </div>
                    `).join('');
                })
                .catch(err => {
                    console.error('Sensor refresh error:', err);
                    showStatus('Error loading sensors', 'error');
                });
        }

        function refreshSensorsWithRetry(retries = 3) {
            fetch(`${API_BASE}/sensors`)
                .then(r => {
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    return r.json();
                })
                .then(data => {
                    const grid = document.getElementById('sensorsGrid');
                    const sensors = data.sensors;

                    if (!sensors || Object.keys(sensors).length === 0) {
                        if (retries > 0) {
                            console.log(`No sensors yet, retrying... (${retries} attempts left)`);
                            setTimeout(() => refreshSensorsWithRetry(retries - 1), 1000);
                            return;
                        }
                        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">No sensors detected. Try rescanning.</div>';
                        return;
                    }

                    grid.innerHTML = Object.entries(sensors).map(([id, sensor]) => `
                        <div class="sensor-card ${sensor.status === 'offline' ? 'offline' : ''}">
                            <div class="name">${sensor.name}</div>
                            <div class="temperature">${sensor.status === 'online' ? sensor.temperature.toFixed(2) : '--'}¬∞C</div>
                            <div class="status">${sensor.status === 'online' ? '‚úì Online' : '‚úó Offline'}</div>
                        </div>
                    `).join('');

                    // Build rename form
                    const renameForm = document.getElementById('renameForm');
                    renameForm.innerHTML = Object.entries(sensors).map(([id, sensor]) => `
                        <div class="probe-rename-form">
                            <input type="text" id="rename_${id}" value="${sensor.name}" placeholder="Probe name">
                            <button class="btn btn-primary" onclick="renameSensor('${id}')">Rename</button>
                        </div>
                    `).join('');
                })
                .catch(err => {
                    console.error('Sensor refresh error:', err);
                    if (retries > 0) {
                        console.log(`Error fetching sensors, retrying... (${retries} attempts left)`);
                        setTimeout(() => refreshSensorsWithRetry(retries - 1), 1500);
                    } else {
                        showStatus('Error loading sensors', 'error');
                    }
                });
        }

        function rescanSensors() {
            fetch(`${API_BASE}/probes/rescan`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    showStatus('‚úì Rescan initiated', 'success');
                    setTimeout(refreshSensors, 1000);
                })
                .catch(err => {
                    console.error('Rescan error:', err);
                    showStatus('Error during rescan', 'error');
                });
        }

        function renameSensor(sensorId) {
            const newName = document.getElementById(`rename_${sensorId}`).value;
            if (!newName.trim()) {
                showStatus('Please enter a name', 'error');
                return;
            }

            fetch(`${API_BASE}/probes/rename`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sensor_id: sensorId, name: newName })
            })
                .then(r => r.json())
                .then(data => {
                    showStatus('‚úì Probe renamed successfully', 'success');
                    refreshSensors();
                })
                .catch(err => {
                    console.error('Rename error:', err);
                    showStatus('Error renaming probe', 'error');
                });
        }

        function enableMockMode() {
            showStatus('‚è≥ Enabling mock mode...', 'info');
            fetch(`${API_BASE}/mock/enable`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    showStatus('‚úì Mock mode enabled', 'success');
                    updateMockModeButton();
                    setTimeout(() => refreshSensorsWithRetry(3), 1000);
                })
                .catch(err => {
                    console.error('Mock enable error:', err);
                    showStatus('Error enabling mock mode', 'error');
                });
        }

        function toggleMockMode() {
            fetch(`${API_BASE}/mock/disable`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    showStatus('‚úì Mock mode disabled', 'success');
                    updateMockModeButton();
                    setTimeout(refreshSensors, 500);
                })
                .catch(err => {
                    console.error('Mock disable error:', err);
                    showStatus('Error disabling mock mode', 'error');
                });
        }

        function updateMockModeButton() {
            fetch(`${API_BASE}/system/status`)
                .then(r => r.json())
                .then(data => {
                    const mockEnabled = data.mock_mode || false;
                    const enableBtn = document.getElementById('enableMockBtn');
                    const disableBtn = document.getElementById('mockModeBtn');
                    
                    if (mockEnabled) {
                        enableBtn.style.display = 'none';
                        disableBtn.style.display = 'inline-block';
                    } else {
                        enableBtn.style.display = 'inline-block';
                        disableBtn.style.display = 'none';
                    }
                })
                .catch(err => console.error('Mock mode button update error:', err));
        }

        // =====================================================================
        // LOGGING TAB
        // =====================================================================

        function startLogging() {
            const duration = document.getElementById('logDuration').value;
            const interval = document.getElementById('logInterval').value;
            const durationSec = duration ? parseInt(duration) * 60 : null;
            const intervalSec = interval ? parseInt(interval) : 60;

            fetch(`${API_BASE}/logging/start`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    duration: durationSec,
                    interval: intervalSec
                })
            })
                .then(r => r.json())
                .then(data => {
                    showStatus(`‚úì Logging started: ${data.filename}`, 'success', 'statusMessageLogging');
                    document.getElementById('startLoggingBtn').disabled = true;
                    document.getElementById('stopLoggingBtn').disabled = false;
                    document.getElementById('loggingStatus').value = 'Logging...';
                    updateLoggingStatus();
                })
                .catch(err => {
                    console.error('Logging start error:', err);
                    showStatus('Error starting logging', 'error', 'statusMessageLogging');
                });
        }

        function stopLogging() {
            fetch(`${API_BASE}/logging/stop`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    showStatus(`‚úì Logging stopped: ${data.filename}`, 'success', 'statusMessageLogging');
                    document.getElementById('startLoggingBtn').disabled = false;
                    document.getElementById('stopLoggingBtn').disabled = true;
                    document.getElementById('loggingStatus').value = 'Stopped';
                })
                .catch(err => {
                    console.error('Logging stop error:', err);
                    showStatus('Error stopping logging', 'error', 'statusMessageLogging');
                });
        }

        function updateLoggingStatus() {
            fetch(`${API_BASE}/system/status`)
                .then(r => r.json())
                .then(data => {
                    const isLogging = data.logging_state === 'logging';
                    document.getElementById('startLoggingBtn').disabled = isLogging;
                    document.getElementById('stopLoggingBtn').disabled = !isLogging;
                    document.getElementById('loggingStatus').value = isLogging ? 'Logging...' : 'Stopped';
                })
                .catch(err => console.error('Logging status error:', err));
        }

        // =====================================================================
        // GRAPHS TAB
        // =====================================================================

        function loadGraphData() {
            fetch(`${API_BASE}/graphs/data`)
                .then(r => r.json())
                .then(data => {
                    const sessions = data.sessions || {};
                    const files = data.files || [];

                    if (files.length === 0) {
                        showStatus('No logged data available', 'info', 'statusMessageGraphs');
                        return;
                    }

                    const selector = document.getElementById('sessionSelector');
                    const select = document.getElementById('sessionSelect');

                    select.innerHTML = files.map(f => `<option value="${f}">${f}</option>`).join('');
                    selector.style.display = 'block';

                    displayGraph();
                    showStatus('‚úì Data loaded', 'success', 'statusMessageGraphs');
                })
                .catch(err => {
                    console.error('Graph data error:', err);
                    showStatus('Error loading graph data', 'error', 'statusMessageGraphs');
                });
        }

        function displayGraph() {
            const sessionFile = document.getElementById('sessionSelect').value;
            if (!sessionFile) return;

            fetch(`${API_BASE}/graphs/data?file=${sessionFile}`)
                .then(r => r.json())
                .then(data => {
                    const sessions = data.sessions || {};
                    const sessionData = sessions[sessionFile] || [];

                    if (sessionData.length === 0) {
                        showStatus('No data in session', 'info', 'statusMessageGraphs');
                        return;
                    }

                    // Get all sensor IDs
                    const sensorIds = new Set();
                    sessionData.forEach(item => {
                        Object.keys(item.readings).forEach(id => sensorIds.add(id));
                    });

                    const labels = sessionData.map(item => {
                        const time = new Date(item.timestamp);
                        return time.toLocaleTimeString();
                    });

                    const colors = ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff'];
                    const datasets = [];

                    Array.from(sensorIds).forEach((sensorId, idx) => {
                        datasets.push({
                            label: sensorId.substring(0, 8),
                            data: sessionData.map(item => item.readings[sensorId] || null),
                            borderColor: colors[idx % colors.length],
                            tension: 0.1,
                            fill: false
                        });
                    });

                    // Destroy existing chart
                    if (graphChart) {
                        graphChart.destroy();
                    }

                    const ctx = document.getElementById('temperatureChart').getContext('2d');
                    graphChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'bottom'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    title: {
                                        display: true,
                                        text: 'Temperature (¬∞C)'
                                    }
                                }
                            }
                        }
                    });

                    // Calculate and display stats
                    const allTemps = [];
                    const sensorStats = {};

                    // Collect all temperatures and organize by sensor
                    sessionData.forEach(item => {
                        Object.entries(item.readings).forEach(([sensorId, temp]) => {
                            if (temp !== null) {
                                allTemps.push(temp);
                                if (!sensorStats[sensorId]) {
                                    sensorStats[sensorId] = {
                                        temps: [],
                                        name: sensorId.substring(0, 8).toUpperCase()
                                    };
                                }
                                sensorStats[sensorId].temps.push(temp);
                            }
                        });
                    });

                    if (allTemps.length > 0) {
                        // Overall stats
                        const min = Math.min(...allTemps);
                        const max = Math.max(...allTemps);
                        const avg = (allTemps.reduce((a, b) => a + b) / allTemps.length).toFixed(2);

                        document.getElementById('statMin').textContent = min.toFixed(2) + '¬∞C';
                        document.getElementById('statMax').textContent = max.toFixed(2) + '¬∞C';
                        document.getElementById('statAvg').textContent = avg + '¬∞C';

                        // Per-sensor stats
                        const overallAvg = parseFloat(avg);
                        const perSensorHtml = Object.entries(sensorStats).map(([sensorId, stats]) => {
                            const temps = stats.temps;
                            const sensorMin = Math.min(...temps);
                            const sensorMax = Math.max(...temps);
                            const sensorAvg = (temps.reduce((a, b) => a + b) / temps.length).toFixed(2);
                            const readings = temps.length;
                            const diffFromAvg = (sensorAvg - overallAvg).toFixed(2);
                            const diffColor = diffFromAvg > 0 ? '#f44336' : diffFromAvg < 0 ? '#4CAF50' : '#999';
                            const diffSign = diffFromAvg > 0 ? '+' : '';

                            return `
                                <div style="background: white; border: 1px solid #e0e0e0; border-radius: 4px; padding: 15px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <h4 style="margin: 0; color: #667eea;">${stats.name}</h4>
                                        <span style="background: #f0f0f0; padding: 4px 8px; border-radius: 3px; font-size: 11px; color: #666;">${readings} readings</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                        <div>
                                            <div style="font-size: 11px; color: #999; margin-bottom: 4px;">Minimum</div>
                                            <div style="font-size: 16px; font-weight: bold; color: #667eea;">${sensorMin.toFixed(2)}¬∞C</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: #999; margin-bottom: 4px;">Maximum</div>
                                            <div style="font-size: 16px; font-weight: bold; color: #764ba2;">${sensorMax.toFixed(2)}¬∞C</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: #999; margin-bottom: 4px;">Average</div>
                                            <div style="font-size: 16px; font-weight: bold; color: #667eea;">${sensorAvg}¬∞C</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: #999; margin-bottom: 4px;">Range</div>
                                            <div style="font-size: 16px; font-weight: bold; color: #764ba2;">${(sensorMax - sensorMin).toFixed(2)}¬∞C</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: #999; margin-bottom: 4px;">Vs Overall Avg</div>
                                            <div style="font-size: 16px; font-weight: bold; color: ${diffColor};">${diffSign}${diffFromAvg}¬∞C</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');

                        document.getElementById('perSensorStats').innerHTML = perSensorHtml;
                        document.getElementById('graphStats').style.display = 'block';
                    }
                })
                .catch(err => {
                    console.error('Display graph error:', err);
                    showStatus('Error displaying graph', 'error', 'statusMessageGraphs');
                });
        }

        function downloadGraphData() {
            window.location.href = `${API_BASE}/graphs/download`;
        }

        // =====================================================================
        // SERIAL MONITOR
        // =====================================================================

        function startSerialMonitor() {
            if (serialMonitorInterval) clearInterval(serialMonitorInterval);

            serialMonitorInterval = setInterval(() => {
                if (!serialMonitorPaused) {
                    updateSerialMonitor();
                }
            }, 500);

            updateSerialMonitor();
        }

        function updateSerialMonitor() {
            const filter = document.getElementById('serialFilter')?.value || '';
            const url = filter
                ? `${API_BASE}/serial/messages?type=${filter}`
                : `${API_BASE}/serial/messages`;

            fetch(url)
                .then(r => r.json())
                .then(data => {
                    const monitor = document.getElementById('serialMonitor');
                    const messages = data.messages || [];

                    if (messages.length === 0) {
                        monitor.innerHTML = '<div class="monitor-line info">Waiting for serial data...</div>';
                        return;
                    }

                    monitor.innerHTML = messages.map(msg => {
                        const time = new Date(msg.timestamp * 1000);
                        const timeStr = time.toLocaleTimeString();
                        const typeClass = msg.type || 'unknown';
                        const typeStr = (msg.type || 'unknown').toUpperCase();

                        return `
                            <div class="monitor-line ${typeClass}">
                                <span class="monitor-timestamp">[${timeStr}]</span>
                                <span class="monitor-type">${typeStr}</span>
                                ${escapeHtml(msg.message)}
                            </div>
                        `;
                    }).join('');

                    monitor.scrollTop = monitor.scrollHeight;
                })
                .catch(err => {
                    console.error('Serial monitor error:', err);
                    const monitor = document.getElementById('serialMonitor');
                    monitor.innerHTML = `<div class="monitor-line error">Error loading serial data: ${err.message}</div>`;
                });
        }

        function toggleSerialMonitor() {
            serialMonitorPaused = !serialMonitorPaused;
            const btn = document.getElementById('pauseResumeBtn');
            btn.textContent = serialMonitorPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
            btn.style.background = serialMonitorPaused ? '#f44336' : '#e0e0e0';
            btn.style.color = serialMonitorPaused ? 'white' : '#333';
        }

        function clearSerialMonitor() {
            if (!confirm('Clear all serial messages? This cannot be undone.')) {
                return;
            }

            fetch(`${API_BASE}/serial/messages`, { method: 'DELETE' })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'ok') {
                        updateSerialMonitor();
                        showStatus('Serial monitor cleared', 'success');
                    }
                })
                .catch(err => {
                    showStatus('Error clearing serial monitor: ' + err.message, 'error');
                });
        }

        function downloadSerialLog() {
            fetch(`${API_BASE}/serial/messages`)
                .then(r => r.json())
                .then(data => {
                    const messages = data.messages || [];

                    if (messages.length === 0) {
                        showStatus('No messages to download', 'info');
                        return;
                    }

                    const lines = messages.map(msg => {
                        const time = new Date(msg.timestamp * 1000).toISOString();
                        const type = (msg.type || 'unknown').toUpperCase();
                        return `[${time}] [${type}] ${msg.message}`;
                    }).join('\n');

                    const blob = new Blob([lines + '\n'], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `serial_log_${Date.now()}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    showStatus(`Downloaded ${messages.length} messages`, 'success');
                })
                .catch(err => {
                    showStatus('Error downloading log: ' + err.message, 'error');
                });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // =====================================================================
        // SETTINGS TAB
        // =====================================================================

        function updateSystemInfo() {
            fetch(`${API_BASE}/system/status`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('infoSystemState').textContent = data.system_state;
                    document.getElementById('infoLoggingState').textContent = data.logging_state;
                    document.getElementById('infoSerialConnected').textContent = data.serial_connected ? 'Yes' : 'No';
                    document.getElementById('infoLastUpdate').textContent = new Date().toLocaleString();
                })
                .catch(err => console.error('System info error:', err));
        }

        function saveSettings() {
            const interval = parseInt(document.getElementById('refreshInterval').value) * 1000;
            if (interval > 0) {
                refreshIntervalMs = interval;
                localStorage.setItem('refreshInterval', interval);
                showStatus('‚úì Settings saved', 'success');
            }
        }

        // =====================================================================
        // INITIALIZATION
        // =====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            // Load saved settings
            const savedInterval = localStorage.getItem('refreshInterval');
            if (savedInterval) {
                refreshIntervalMs = parseInt(savedInterval);
                document.getElementById('refreshInterval').value = refreshIntervalMs / 1000;
            }

            // Initial updates
            updateSystemStatus();
            updateMockModeButton();
            refreshSensors();
            updateLoggingStatus();

            // Auto-refresh
            setInterval(refreshSensors, refreshIntervalMs);
            setInterval(updateSystemStatus, 5000);
            setInterval(updateLoggingStatus, 5000);

            // Auto-scroll (disabled for sensors tab)
            document.getElementById('sensorsGrid').addEventListener('scroll', (e) => {
                e.preventDefault();
            });
        });
    </script>
</body>
</html>
